#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å¢å¼ºçš„å®‰å…¨å®¡è®¡æ¨¡æ¿ - ä¸“é—¨ç”¨äºå‡å°‘è¯¯æŠ¥
"""

def get_enhanced_security_audit_template() -> str:
    """è·å–å¢å¼ºçš„å®‰å…¨å®¡è®¡æ¨¡æ¿ï¼Œä¸“é—¨è®¾è®¡ç”¨äºå‡å°‘è¯¯æŠ¥"""
    
    return """
ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä»£ç å®‰å…¨å®¡è®¡ä¸“å®¶ã€‚è¯·ä»”ç»†åˆ†æä»¥ä¸‹ä»£ç ï¼Œè¯†åˆ«çœŸå®çš„å®‰å…¨æ¼æ´ï¼ŒåŒæ—¶é¿å…è¯¯æŠ¥ã€‚

## é‡è¦æŒ‡å¯¼åŸåˆ™

### ğŸš« é¿å…è¯¯æŠ¥çš„å…³é”®ç‚¹ï¼š
1. **ä¸šåŠ¡å¸¸é‡ä¸æ˜¯æ•æ„Ÿä¿¡æ¯**ï¼šå¦‚ 2L, 1L, 10, 20 ç­‰æ•°å­—å¸¸é‡é€šå¸¸æ˜¯ä¸šåŠ¡é€»è¾‘å‚æ•°
2. **JavaåŒ…å£°æ˜ä¸æ˜¯ä¿¡æ¯æ³„éœ²**ï¼špackage å£°æ˜æ˜¯æ­£å¸¸çš„ä»£ç ç»“æ„
3. **æ­£å¸¸çš„IPè·å–ä¸æ˜¯é£é™©**ï¼šè€ƒå‹¤ç³»ç»Ÿè·å–æœ¬æœºIPæ˜¯åˆç†éœ€æ±‚
4. **æ¡†æ¶å®‰å…¨æœºåˆ¶è¦è¯†åˆ«**ï¼šSpring Securityã€MyBatiså‚æ•°åŒ–æŸ¥è¯¢ç­‰æ˜¯å®‰å…¨çš„
5. **ä¸Šä¸‹æ–‡å¾ˆé‡è¦**ï¼šåŒæ ·çš„ä»£ç åœ¨ä¸åŒä¸Šä¸‹æ–‡ä¸­é£é™©ä¸åŒ

### âœ… é‡ç‚¹å…³æ³¨çœŸå®é£é™©ï¼š
1. **çœŸæ­£çš„ç¡¬ç¼–ç å¯†ç **ï¼šåŒ…å«passwordã€secretã€keyç­‰æ•æ„Ÿè¯çš„æ˜æ–‡å‡­æ®
2. **å®é™…çš„SQLæ³¨å…¥**ï¼šä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥æ„å»ºSQLï¼Œç‰¹åˆ«æ˜¯MyBatisçš„${}è¯­æ³•
3. **æ˜æ˜¾çš„æƒé™ç»•è¿‡**ï¼šç¼ºå°‘æƒé™æ£€æŸ¥çš„æ•æ„Ÿæ“ä½œ
4. **è·¯å¾„éå†æ¼æ´**ï¼šæœªéªŒè¯çš„æ–‡ä»¶è·¯å¾„æ“ä½œ
5. **XSSå’ŒCSRF**ï¼šæœªè½¬ä¹‰çš„ç”¨æˆ·è¾“å…¥è¾“å‡º

## åˆ†ææ¡†æ¶

### æŠ€æœ¯æ ˆè¯†åˆ«ï¼š
- **Springæ¡†æ¶**ï¼š@RequestMapping, @GetMappingç­‰æ³¨è§£æä¾›åŸºç¡€å®‰å…¨ä¿æŠ¤
- **MyBatis**ï¼š#{} æ˜¯å®‰å…¨çš„å‚æ•°åŒ–æŸ¥è¯¢ï¼Œ${} å­˜åœ¨SQLæ³¨å…¥é£é™©
- **JPA/Hibernate**ï¼šfindOne(), findBy*() ç­‰æ–¹æ³•æ˜¯å®‰å…¨çš„
- **Spring Security**ï¼š@PreAuthorize, @Secured ç­‰æ³¨è§£æä¾›æƒé™æ§åˆ¶

### ä¸šåŠ¡é€»è¾‘ç†è§£ï¼š
- **OAç³»ç»Ÿç‰¹ç‚¹**ï¼šè€ƒå‹¤ã€é‚®ä»¶ã€æ–‡ä»¶ç®¡ç†ç­‰åŠŸèƒ½æœ‰å…¶ç‰¹å®šçš„å®‰å…¨éœ€æ±‚
- **æ­£å¸¸ä¸šåŠ¡æµç¨‹**ï¼šç”¨æˆ·ç™»å½• â†’ æƒé™æ£€æŸ¥ â†’ ä¸šåŠ¡æ“ä½œ â†’ ç»“æœè¿”å›
- **åˆç†çš„æ•°æ®è·å–**ï¼šè·å–ç”¨æˆ·IDã€éƒ¨é—¨ä¿¡æ¯ã€IPåœ°å€ç­‰å¯èƒ½æ˜¯æ­£å¸¸éœ€æ±‚

## è¾“å‡ºæ ¼å¼

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼ŒåªæŠ¥å‘Šç¡®å®å­˜åœ¨çš„å®‰å…¨é—®é¢˜ï¼š

```json
{
  "findings": [
    {
      "type": "å…·ä½“çš„æ¼æ´ç±»å‹",
      "severity": "HIGH|MEDIUM|LOW",
      "line": è¡Œå·,
      "code": "å­˜åœ¨é—®é¢˜çš„ä»£ç ç‰‡æ®µ",
      "description": "è¯¦ç»†çš„é—®é¢˜æè¿°ï¼Œè¯´æ˜ä¸ºä»€ä¹ˆè¿™æ˜¯ä¸€ä¸ªçœŸå®çš„å®‰å…¨é£é™©",
      "recommendation": "å…·ä½“çš„ä¿®å¤å»ºè®®",
      "confidence": 0.8,
      "evidence": "æ”¯æŒåˆ¤æ–­çš„è¯æ®ï¼Œè¯´æ˜ä¸ºä»€ä¹ˆä¸æ˜¯è¯¯æŠ¥"
    }
  ]
}
```

## ç½®ä¿¡åº¦è¯„åˆ†æ ‡å‡†ï¼š
- **0.9-1.0**ï¼šæ˜ç¡®çš„å®‰å…¨æ¼æ´ï¼Œæœ‰ç›´æ¥è¯æ®ï¼ˆå¦‚æ˜æ–‡å¯†ç ã€SQLæ‹¼æ¥ï¼‰
- **0.7-0.8**ï¼šå¾ˆå¯èƒ½çš„å®‰å…¨é—®é¢˜ï¼Œéœ€è¦è¿›ä¸€æ­¥éªŒè¯
- **0.5-0.6**ï¼šå¯èƒ½çš„å®‰å…¨é£é™©ï¼Œä½†éœ€è¦æ›´å¤šä¸Šä¸‹æ–‡
- **0.3-0.4**ï¼šä½é£é™©æˆ–å¯èƒ½æ˜¯è¯¯æŠ¥ï¼ˆå¦‚æ­£å¸¸çš„ç”¨æˆ·ä¿¡æ¯è·å–ï¼‰
- **0.1-0.2**ï¼šå¾ˆå¯èƒ½æ˜¯è¯¯æŠ¥ï¼ˆå¦‚åŒ…åå£°æ˜ã€ä¸šåŠ¡å¸¸é‡ï¼‰

## ä¸¥æ ¼çš„æŠ¥å‘Šæ ‡å‡†ï¼š
- **åªæŠ¥å‘Šç½®ä¿¡åº¦ â‰¥ 0.7 çš„é—®é¢˜**
- **å¯¹äº0.5-0.6çš„é—®é¢˜ï¼Œå¿…é¡»æœ‰æ˜ç¡®çš„æ”»å‡»åœºæ™¯è¯´æ˜**
- **é¿å…æŠ¥å‘Šæ­£å¸¸çš„æ¡†æ¶ä½¿ç”¨æ¨¡å¼**
- **åŒºåˆ†çœŸå®çš„å®‰å…¨é£é™©å’Œä»£ç è´¨é‡é—®é¢˜**

## ç‰¹åˆ«æ³¨æ„ï¼š
1. å¦‚æœä»£ç ç‰‡æ®µçœ‹èµ·æ¥åƒæ˜¯æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘ï¼Œè¯·ä»”ç»†è€ƒè™‘æ˜¯å¦çœŸçš„å­˜åœ¨å®‰å…¨é£é™©
2. å¯¹äºå¸¸è§çš„æ¡†æ¶æ¨¡å¼ï¼ˆå¦‚Spring MVCã€MyBatisç­‰ï¼‰ï¼Œè¯·åŸºäºæ¡†æ¶çš„å®‰å…¨æœºåˆ¶è¿›è¡Œåˆ¤æ–­
3. ä¸šåŠ¡å¸¸é‡ã€é…ç½®å‚æ•°ã€åŒ…å£°æ˜ç­‰é€šå¸¸ä¸æ˜¯å®‰å…¨é—®é¢˜
4. åªæœ‰å½“ä½ ç¡®ä¿¡å­˜åœ¨çœŸå®çš„å®‰å…¨é£é™©æ—¶ï¼Œæ‰åº”è¯¥æŠ¥å‘Šé—®é¢˜

ç°åœ¨è¯·åˆ†æä»¥ä¸‹ä»£ç ï¼š

```{language}
{code}
```

æ–‡ä»¶è·¯å¾„ï¼š{file_path}
"""

def get_framework_specific_rules() -> dict:
    """è·å–æ¡†æ¶ç‰¹å®šçš„å®‰å…¨è§„åˆ™"""
    return {
        "spring": {
            "safe_patterns": [
                "@RequestMapping", "@GetMapping", "@PostMapping",
                "@SessionAttribute", "@PathVariable", "@RequestParam",
                "@PreAuthorize", "@Secured", "@RolesAllowed"
            ],
            "risk_patterns": [
                "request.getParameter", "response.getWriter().write"
            ]
        },
        "mybatis": {
            "safe_patterns": ["#{"],
            "risk_patterns": ["${"]
        },
        "jpa": {
            "safe_patterns": [
                ".findOne(", ".findBy", ".save(", ".delete(",
                "@Query", "@NamedQuery"
            ],
            "risk_patterns": [
                "createQuery(", "createNativeQuery("
            ]
        }
    }

def get_business_context_rules() -> dict:
    """è·å–ä¸šåŠ¡ä¸Šä¸‹æ–‡è§„åˆ™"""
    return {
        "oa_system": {
            "normal_operations": [
                "è·å–ç”¨æˆ·ID", "è·å–éƒ¨é—¨ä¿¡æ¯", "è®°å½•IPåœ°å€",
                "åˆ†é¡µæŸ¥è¯¢", "çŠ¶æ€æ›´æ–°", "æ–‡ä»¶ä¸Šä¼ ä¸‹è½½"
            ],
            "sensitive_operations": [
                "å¯†ç ä¿®æ”¹", "æƒé™åˆ†é…", "ç³»ç»Ÿé…ç½®",
                "æ•°æ®å¯¼å‡º", "æ—¥å¿—æŸ¥çœ‹"
            ]
        },
        "attendance_system": {
            "normal_ip_usage": [
                "InetAddress.getLocalHost()", "getHostAddress()",
                "è€ƒå‹¤æ‰“å¡", "ä½ç½®è®°å½•"
            ]
        }
    }
