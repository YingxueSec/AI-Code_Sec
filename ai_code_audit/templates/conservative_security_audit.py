#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ä¿å®ˆçš„å®‰å…¨å®¡è®¡æ¨¡æ¿ - ä¸“é—¨ç”¨äºå‡å°‘è¯¯æŠ¥ï¼ŒåªæŠ¥å‘Šé«˜ç½®ä¿¡åº¦çš„å®‰å…¨é—®é¢˜
"""

def get_conservative_security_audit_template() -> str:
    """è·å–ä¿å®ˆçš„å®‰å…¨å®¡è®¡æ¨¡æ¿ï¼ŒåªæŠ¥å‘Šç¡®å®å­˜åœ¨çš„é«˜é£é™©å®‰å…¨é—®é¢˜"""
    
    return """
ä½ æ˜¯ä¸€ä¸ªç»éªŒä¸°å¯Œçš„ä»£ç å®‰å…¨å®¡è®¡ä¸“å®¶ã€‚è¯·ä»¥æå…¶ä¸¥æ ¼å’Œä¿å®ˆçš„æ ‡å‡†åˆ†æä»¥ä¸‹ä»£ç ï¼ŒåªæŠ¥å‘Šç¡®å®å­˜åœ¨çš„é«˜é£é™©å®‰å…¨æ¼æ´ã€‚

## ğŸš¨ ä¸¥æ ¼çš„æŠ¥å‘Šæ ‡å‡†

### åªæŠ¥å‘Šä»¥ä¸‹ç±»å‹çš„ç¡®å®šå®‰å…¨é—®é¢˜ï¼š
1. **æ˜æ–‡ç¡¬ç¼–ç å¯†ç /å¯†é’¥** - å¿…é¡»åŒ…å«passwordã€secretã€keyç­‰æ•æ„Ÿè¯ä¸”ä¸ºæ˜æ–‡
2. **æ˜ç¡®çš„SQLæ³¨å…¥** - å¿…é¡»æ˜¯å­—ç¬¦ä¸²æ‹¼æ¥æ„å»ºSQLï¼Œä¸æ˜¯å‚æ•°åŒ–æŸ¥è¯¢
3. **æ˜æ˜¾çš„æƒé™ç»•è¿‡** - å¿…é¡»æ˜¯å®Œå…¨ç¼ºå°‘æƒé™æ£€æŸ¥çš„æ•æ„Ÿæ“ä½œ
4. **ç¡®å®šçš„è·¯å¾„éå†** - å¿…é¡»æ˜¯æœªéªŒè¯çš„æ–‡ä»¶è·¯å¾„æ“ä½œ
5. **æ˜ç¡®çš„XSSæ¼æ´** - å¿…é¡»æ˜¯æœªè½¬ä¹‰çš„ç”¨æˆ·è¾“å…¥ç›´æ¥è¾“å‡º

### ğŸš« ä¸è¦æŠ¥å‘Šä»¥ä¸‹æƒ…å†µï¼š
1. **æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘** - å¦‚ç”¨æˆ·ä¿¡æ¯è·å–ã€çŠ¶æ€æ£€æŸ¥ç­‰
2. **æ¡†æ¶å®‰å…¨æœºåˆ¶** - Spring Securityã€MyBatiså‚æ•°åŒ–æŸ¥è¯¢ç­‰
3. **ä¸šåŠ¡å¸¸é‡** - å¦‚2Lã€1Lã€çŠ¶æ€ç ç­‰æ•°å­—å¸¸é‡
4. **åŒ…åå£°æ˜** - JavaåŒ…å£°æ˜ä¸æ˜¯å®‰å…¨é—®é¢˜
5. **å·¥å…·ç±»æ–¹æ³•** - æ­£å¸¸çš„å·¥å…·æ–¹æ³•è°ƒç”¨
6. **å¯èƒ½çš„é—®é¢˜** - åªæœ‰åœ¨æœ‰æ˜ç¡®æ”»å‡»è·¯å¾„æ—¶æ‰æŠ¥å‘Š

## æŠ€æœ¯æ ˆç†è§£

### Springæ¡†æ¶å®‰å…¨æœºåˆ¶ï¼š
- `@RequestMapping`ã€`@GetMapping`ç­‰æ³¨è§£æä¾›åŸºç¡€è·¯ç”±ä¿æŠ¤
- `@SessionAttribute`ã€`@PathVariable`ç­‰å‚æ•°ç»‘å®šæ˜¯å®‰å…¨çš„
- `session.getAttribute("userId")`æ˜¯æ­£å¸¸çš„ç”¨æˆ·èº«ä»½è·å–

### æ•°æ®åº“è®¿é—®å®‰å…¨ï¼š
- **JPA/Hibernate**: `findOne()`ã€`findBy*()`ç­‰æ–¹æ³•ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼Œæ˜¯å®‰å…¨çš„
- **MyBatis**: `#{}`å‚æ•°æ˜¯å®‰å…¨çš„ï¼Œ`${}`å‚æ•°å­˜åœ¨SQLæ³¨å…¥é£é™©
- **Spring Data**: Repositoryæ¥å£æ–¹æ³•æ˜¯å®‰å…¨çš„

### ä¸šåŠ¡é€»è¾‘ç†è§£ï¼š
- **OAç³»ç»Ÿç‰¹ç‚¹**: è€ƒå‹¤ã€é‚®ä»¶ã€æ–‡ä»¶ç®¡ç†ç­‰åŠŸèƒ½æœ‰å…¶ç‰¹å®šéœ€æ±‚
- **ç”¨æˆ·ä¿¡æ¯è·å–**: ä»sessionè·å–userIdå¹¶æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯æ˜¯æ­£å¸¸æ“ä½œ
- **æƒé™æ£€æŸ¥**: éœ€è¦åŒºåˆ†"è·å–ç”¨æˆ·ä¿¡æ¯"å’Œ"æƒé™éªŒè¯"

## ç½®ä¿¡åº¦è¦æ±‚

### ä¸¥æ ¼çš„ç½®ä¿¡åº¦æ ‡å‡†ï¼š
- **åªæŠ¥å‘Šç½®ä¿¡åº¦ â‰¥ 0.8 çš„é—®é¢˜**
- **å¿…é¡»æœ‰æ˜ç¡®çš„æ”»å‡»åœºæ™¯å’Œåˆ©ç”¨æ–¹å¼**
- **å¿…é¡»èƒ½å¤Ÿé€ æˆå®é™…çš„å®‰å…¨å½±å“**

### è¯æ®è¦æ±‚ï¼š
- **ä»£ç è¯æ®**: æŒ‡å‡ºå…·ä½“çš„é—®é¢˜ä»£ç è¡Œ
- **æ”»å‡»è·¯å¾„**: è¯´æ˜å¦‚ä½•åˆ©ç”¨è¿™ä¸ªæ¼æ´
- **å®‰å…¨å½±å“**: è¯´æ˜å¯èƒ½é€ æˆçš„å±å®³

## è¾“å‡ºæ ¼å¼

åªæœ‰å½“ä½ ç¡®ä¿¡å­˜åœ¨çœŸå®çš„é«˜é£é™©å®‰å…¨é—®é¢˜æ—¶ï¼Œæ‰æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

```json
{
  "findings": [
    {
      "type": "å…·ä½“çš„æ¼æ´ç±»å‹ï¼ˆå¦‚ï¼šç¡¬ç¼–ç å¯†ç ã€SQLæ³¨å…¥ã€æƒé™ç»•è¿‡ï¼‰",
      "severity": "HIGH|MEDIUM",
      "line": è¡Œå·,
      "code": "å­˜åœ¨é—®é¢˜çš„å…·ä½“ä»£ç ç‰‡æ®µ",
      "description": "è¯¦ç»†è¯´æ˜ä¸ºä»€ä¹ˆè¿™æ˜¯ä¸€ä¸ªç¡®å®šçš„å®‰å…¨é£é™©ï¼ŒåŒ…å«æ”»å‡»åœºæ™¯",
      "recommendation": "å…·ä½“çš„ä¿®å¤å»ºè®®",
      "confidence": 0.8ä»¥ä¸Š,
      "attack_scenario": "å…·ä½“çš„æ”»å‡»åˆ©ç”¨æ–¹å¼",
      "security_impact": "å¯èƒ½é€ æˆçš„å®‰å…¨å½±å“"
    }
  ]
}
```

## ç‰¹åˆ«æ³¨æ„

1. **å®å¯æ¼æŠ¥ï¼Œä¸è¦è¯¯æŠ¥** - å¦‚æœä¸ç¡®å®šæ˜¯å¦ä¸ºå®‰å…¨é—®é¢˜ï¼Œä¸è¦æŠ¥å‘Š
2. **åŒºåˆ†ä»£ç è´¨é‡å’Œå®‰å…¨é—®é¢˜** - åªæŠ¥å‘ŠçœŸæ­£çš„å®‰å…¨é£é™©
3. **è€ƒè™‘ä¸šåŠ¡ä¸Šä¸‹æ–‡** - ç†è§£ä»£ç çš„ä¸šåŠ¡ç”¨é€”
4. **éªŒè¯æ”»å‡»å¯è¡Œæ€§** - ç¡®ä¿æŠ¥å‘Šçš„é—®é¢˜ç¡®å®å¯ä»¥è¢«åˆ©ç”¨

å¦‚æœä»£ç çœ‹èµ·æ¥æ˜¯æ­£å¸¸çš„ä¸šåŠ¡é€»è¾‘æˆ–ä½¿ç”¨äº†å®‰å…¨çš„æ¡†æ¶æœºåˆ¶ï¼Œè¯·è¿”å›ç©ºçš„findingsæ•°ç»„ã€‚

ç°åœ¨è¯·åˆ†æä»¥ä¸‹ä»£ç ï¼š

```{language}
{code}
```

æ–‡ä»¶è·¯å¾„ï¼š{file_path}
"""

def get_high_confidence_rules() -> dict:
    """è·å–é«˜ç½®ä¿¡åº¦å®‰å…¨è§„åˆ™"""
    return {
        "definite_vulnerabilities": {
            "hardcoded_credentials": [
                r'password\s*=\s*["\'][^"\']+["\']',
                r'secret\s*=\s*["\'][^"\']+["\']',
                r'key\s*=\s*["\'][^"\']+["\']'
            ],
            "sql_injection": [
                r'\+.*["\'].*SELECT.*FROM',
                r'String.*sql.*\+.*request\.getParameter',
                r'\$\{[^}]+\}.*WHERE'
            ],
            "path_traversal": [
                r'new\s+File\(.*request\.getParameter',
                r'FileInputStream\(.*request\.getParameter'
            ]
        },
        "safe_patterns": {
            "spring_security": [
                r'@PreAuthorize', r'@Secured', r'@RolesAllowed'
            ],
            "parameterized_queries": [
                r'#\{[^}]+\}', r'\.findOne\(', r'\.findBy\w+\('
            ],
            "normal_operations": [
                r'session\.getAttribute\(["\']userId["\']',
                r'Long\.parseLong\(.*userId',
                r'@RequestMapping', r'@GetMapping', r'@PostMapping'
            ]
        }
    }
